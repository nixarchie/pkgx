#!/usr/bin/env sh
set -eus

export PATH="$PKGX_LIB:$HOME/.local/bin:$PATH"
export LIB="$PKGX_LIB/lib"
export CMD="$PKGX_LIB/commands"

. "$LIB/common.sh"
. "$LIB/backend.sh"
. "$LIB/config.sh"

#pkgx_print_config
#pkgx_debug_config

case "$PKGX_INTERFACE" in
  pacman)  . "$LIB/interface/pacman.sh" ;;
  apt)     . "$LIB/interface/apt.sh" ;;
  nix)     . "$LIB/interface/nix.sh" ;;
  generic) : ;;
esac

# THIS is the important part
if type pkgx_cmd >/dev/null 2>&1; then
  pkgx_cmd "$@"
  exit 0
fi

# fallback generic dispatcher
case "${1:-}" in
  add|install)   shift; backend_add "$@" ;;
  rm)    shift; backend_rm "$@" ;;
  sync)  backend_sync ;;
  list|show)  backend_list ;;
  -h|--help)
    exec sh "$LIB/help.sh"
    ;;
  *)
    die "unknown command: ${1:-}"
    ;;
esac

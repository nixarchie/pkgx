#!/bin/sh
set -eu

# ---- config ----
PREFIX=${PREFIX:-"$HOME/.local"}
BIN_DIR="$PREFIX/bin"

PKGX_BIN=pkgx
COMMANDS_DIR=commands
LIB_DIR=lib

DEST_PKGX="$BIN_DIR/$PKGX_BIN"
DEST_COMMANDS="$BIN_DIR/commands"
DEST_LIB="$BIN_DIR/lib"

# ---- sanity checks ----
[ -f "$PKGX_BIN" ] || { echo "error: pkgx not found"; exit 1; }
[ -d "$COMMANDS_DIR" ] || { echo "error: commands/ not found"; exit 1; }
[ -d "$LIB_DIR" ] || { echo "error: lib/ not found"; exit 1; }

echo "→ Installing pkgx to $BIN_DIR"

# ---- dirs ----
mkdir -p "$BIN_DIR"

# ---- install main binary ----
install -m 755 "$PKGX_BIN" "$DEST_PKGX"

# ---- install support dirs ----
rm -rf "$DEST_COMMANDS" "$DEST_LIB"

cp -R "$COMMANDS_DIR" "$DEST_COMMANDS"
cp -R "$LIB_DIR" "$DEST_LIB"

# ---- fix permissions ----
find "$DEST_COMMANDS" "$DEST_LIB" -type f -name '*.sh' -exec chmod 755 {} \;

# ---- done ----
if command -v pkgx >/dev/null 2>&1; then
    echo "✓ pkgx installed successfully"
else
    echo "⚠ $BIN_DIR is not in PATH"
    echo "  export PATH=\"$BIN_DIR:\$PATH\""
fi
